import os
import requests
from flask import Flask, request
from dotenv import load_dotenv
import urllib.parse
from datetime import datetime
from pymongo import MongoClient
import re
from groq import Groq # <-- à¦¨à¦¤à§à¦¨ à¦‡à¦®à§à¦ªà§‹à¦°à§à¦Ÿ: google.generativeai à¦à¦° à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à§‡

# .env à¦«à¦¾à¦‡à¦² à¦¥à§‡à¦•à§‡ Environment Variables à¦²à§‹à¦¡ à¦•à¦°à¦¾à¦° à¦œà¦¨à§à¦¯
load_dotenv()

# Flask à¦…à§à¦¯à¦¾à¦ª à¦‡à¦¨à¦¿à¦¶à¦¿à§Ÿà¦¾à¦²à¦¾à¦‡à¦œ à¦•à¦°à¦¾
app = Flask(__name__)

# Environment Variables à¦¥à§‡à¦•à§‡ Key à¦à¦¬à¦‚ Token à¦—à§à¦²à§‹ à¦¨à§‡à¦“à§Ÿà¦¾
FACEBOOK_PAGE_ACCESS_TOKEN = os.getenv('FACEBOOK_PAGE_ACCESS_TOKEN')
VERIFY_TOKEN = os.getenv('VERIFY_TOKEN')
GROQ_API_KEY = os.getenv('GROQ_API_KEY') # <-- à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨: GEMINI_API_KEY à¦à¦° à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à§‡
MONGO_URI = os.getenv('MONGO_URI')
TELEGRAM_USERNAME = os.getenv('TELEGRAM_USERNAME')
CALLMEBOT_API_KEY = os.getenv('CALLMEBOT_API_KEY')

# --- à¦¡à§‡à¦Ÿà¦¾à¦¬à§‡à¦¸ à¦•à¦¾à¦¨à§‡à¦•à¦¶à¦¨ ---
try:
    client = MongoClient(MONGO_URI)
    db = client.chatbot_db
    chat_history_collection = db.chat_history
    otn_tokens_collection = db.otn_tokens
    customer_details_collection = db.customer_details
    print("MongoDB à¦¡à§‡à¦Ÿà¦¾à¦¬à§‡à¦¸à§‡à¦° à¦¸à¦¾à¦¥à§‡ à¦¸à¦«à¦²à¦­à¦¾à¦¬à§‡ à¦¸à¦‚à¦¯à§à¦•à§à¦¤à¥¤")
except Exception as e:
    print(f"MongoDB à¦¸à¦‚à¦¯à§‹à¦—à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾: {e}")
    client = None
# -------------------------

KNOWLEDGE_BASE = """
# --- à¦†à¦®à¦¾à¦° à¦¹à§‹à¦®à¦®à§‡à¦¡ à¦«à§à¦°à§‹à¦œà§‡à¦¨ à¦«à§à¦¡ à¦à¦° à¦¤à¦¥à§à¦¯ ---
 
## à¦†à¦®à¦¾à¦¦à§‡à¦° à¦¸à¦®à§à¦ªà¦°à§à¦•à§‡
à¦†à¦®à¦°à¦¾ "à¦˜à¦°à§‡à¦° à¦–à¦¾à¦¬à¦¾à¦°" à¦¸à¦®à§à¦ªà§à¦°à§à¦¨ à¦¬à¦¾à¦¸à¦¾à§Ÿ à¦…à¦¤à§à¦¯à¦¨à§à¦¤ à¦ªà¦°à¦šà§à¦›à¦¨à§à¦¨à¦­à¦¾à¦¬à§‡ à¦«à§à¦°à§‹à¦œà§‡à¦¨ à¦«à§à¦¡ à¦¤à§ˆà¦°à¦¿ à¦•à¦°à§‡ à¦¥à¦¾à¦•à¦¿à¥¤ à¦†à¦®à¦¾à¦°à¦¾ à¦…à¦¨à¦²à¦¾à¦‡à¦¨ à¦…à¦°à§à¦¡à¦¾à¦° à¦à¦¬à¦‚ à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦¸à§‡à¦¬à¦¾ à¦¦à¦¿à§Ÿà§‡ à¦¥à¦¾à¦•à¦¿à¥¤ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦ªà§à¦°à¦§à¦¾à¦¨ à¦²à¦•à§à¦·à§à¦¯ à¦¹à¦²à§‹ à¦—à§à¦°à¦¾à¦¹à¦•à¦¦à§‡à¦° à¦¸à§à¦¸à§à¦¬à¦¾à¦¦à§ à¦à¦¬à¦‚ à¦¸à§à¦¬à¦¾à¦¸à§à¦¥à§à¦¯à¦•à¦° à¦–à¦¾à¦¬à¦¾à¦° à¦¸à¦°à¦¬à¦°à¦¾à¦¹ à¦•à¦°à¦¾à¥¤
## à¦®à§‡à¦¨à§à¦¯à§ à¦²à¦¿à¦¸à§à¦Ÿ
### à¦†à¦¸à¦¸à¦¾à¦²à¦¾à¦®à§ à¦†à¦²à¦¾à¦‡à¦•à§à¦® 
à¦†à¦ªà¦¨à¦¾à¦¦à§‡à¦° à¦œà¦¨à§à¦¯ à¦¨à¦¿à§Ÿà§‡ à¦à¦¸à§‡à¦›à¦¿ à¦¸à§à¦¸à§à¦¬à¦¾à¦¦à§ à¦à¦¬à¦‚ à¦¸à§à¦¬à¦¾à¦¸à§à¦¥à§à¦¯à¦•à¦° à¦«à§à¦°à§‹à¦œà§‡à¦¨ à¦«à§à¦¡à§‡à¦° à¦®à§‡à¦¨à§à¦¯à§à¥¤ à¦¨à¦¿à¦šà§‡ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦®à§‡à¦¨à§à¦¯à§ à¦²à¦¿à¦¸à§à¦Ÿ à¦¦à§‡à¦“à§Ÿà¦¾ à¦¹à¦²à§‹:
à§§) à¦šà¦¿à¦•à§‡à¦¨ à¦°à§‹à¦² à§§à§« à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦•    à§¨à§¨à§« à¦Ÿà¦¾à¦•à¦¾
à§¨) à¦­à§‡à¦œà¦¿à¦Ÿà§‡à¦¬à¦² à¦°à§‹à¦² à§§à§« à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§§à§«à§¦ à¦Ÿà¦¾à¦•à¦¾
à§©) à¦¬à¦¿à¦« à¦°à§‹à¦² à§§à§¦ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§¨à§«à§¦ à¦Ÿà¦¾à¦•à¦¾ 
à§ª) à¦šà¦¿à¦•à§‡à¦¨ à¦¸à¦®à§à¦šà¦¾ à§§à§« à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§¨à§¨à§« à¦Ÿà¦¾à¦•à¦¾ 
à§«) à¦­à§‡à¦œà¦¿à¦Ÿà§‡à¦¬à¦² à¦¸à¦®à§à¦šà¦¾ à§§à§« à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§§à§«à§¦ à¦Ÿà¦¾à¦•à¦¾ 
à§¬) à¦¬à¦¿à¦« à¦¸à¦®à§à¦šà¦¾ à§§à§¦ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§¨à§«à§¦ à¦Ÿà¦¾à¦•à¦¾ 
à§­) à¦šà¦¿à¦•à§‡à¦¨ à¦¸à¦¿à¦™à§à¦—à¦¾à¦°à¦¾ Û±Û° à¦ªà¦¿à¦¸à§‡à¦°  à¦ªà§à¦¯à¦¾à¦• à§§à§«à§¦ à¦Ÿà¦¾à¦•à¦¾ 
à§®) à¦†à¦²à§ à¦¸à¦¿à¦™à§à¦—à¦¾à¦°à¦¾ à§§à§¦ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§§à§¦à§¦ à¦Ÿà¦¾à¦•à¦¾ 
à§¯) à¦šà¦¿à¦•à§‡à¦¨ à¦•à¦²à¦¿à¦œà¦¾ à¦¸à¦¿à¦™à§à¦—à¦¾à¦°à¦¾ à§§à§¦ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§§à§¬à§¦ à¦Ÿà¦¾à¦•à¦¾ à¥¤
à§§à§¦) à¦†à¦²à§ à¦ªà§à¦°à¦¿  à§¨à§¦ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§§à§¬à§¦ à¦Ÿà¦¾à¦•à¦¾ 
à§§à§§) à¦¡à¦¾à¦² à¦ªà§à¦°à¦¿ à§¨à§¦ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§§à§¬à§¦ à¦Ÿà¦¾à¦•à¦¾ 
à§§à§¨) à¦šà¦¿à¦•à§‡à¦¨ à¦¨à¦¾à¦—à§‡à¦Ÿà¦¸ à§§à§¨ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§¨à§ªà§¦ à¦Ÿà¦¾à¦•à¦¾ 
à§§à§©) à¦šà¦¿à¦•à§‡à¦¨ à¦Ÿà¦¿à¦•à¦¿à¦¯à¦¼à¦¾ à¦•à¦¾à¦¬à¦¾à¦¬ à§§à§¨ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§¨à§ªà§¦ à¦Ÿà¦¾à¦•à¦¾
à§§à§ª) à¦šà¦¿à¦•à§‡à¦¨ à¦à¦¾à¦² à¦¡à§‹à¦¨à¦¾à¦Ÿ  à§§à§¨ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§¨à§ªà§¦ à¦Ÿà¦¾à¦•à¦¾
à§§à§«) à¦šà¦¿à¦•à§‡à¦¨ à¦•à¦¾à¦Ÿà¦²à§‡à¦Ÿ à§§à§¨ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§¨à§ªà§¦ à¦Ÿà¦¾à¦•à¦¾ à¥¤ 
à§§à§¬) à¦šà¦¾à¦°à¦•à§‹à¦¨à¦¾ à¦ªà¦°à§‹à¦Ÿà¦¾  
      à¦•)à§¨à§¦ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦•(à§§à§¨à§¦à§¦gm )220à¦Ÿà¦¾à¦•à¦¾ à¥¤
      à¦–)à§¨à§¦ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• (à§§à§«à§¦à§¦ gm) 260à¦Ÿà¦¾à¦•à¦¾à¥¤
      à¦—) à§§à§¦ à¦ªà¦¿à¦¸ à¦†à¦²à§ à¦ªà¦°à§‹à¦Ÿà¦¾ à§¨à§«à§¦ à¦Ÿà¦¾à¦•à¦¾

à§§à§­) à¦†à¦Ÿà¦¾ à¦°à§à¦Ÿà¦¿ à§¨à§¦ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§§à§¬à§¦ à¦Ÿà¦¾à¦•à¦¾ 
à§§à§®) à¦®à¦¯à¦¼à¦¦à¦¾ à¦°à§à¦Ÿà¦¿ à§¨à§¦ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§§à§®à§¦ à¦Ÿà¦¾à¦•à¦¾ 
à§§à§¯) à¦²à¦¾à¦² à¦†à¦Ÿà¦¾ à¦°à§à¦Ÿà¦¿  à§¨à§¦ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§§à§®à§¦ à¦Ÿà¦¾à¦•à¦¾ 
à§¨à§¦) à¦šà¦¾à¦‰à¦²à§‡à¦° à¦°à§à¦Ÿà¦¿ à§¨à§¦ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• 200 à¦Ÿà¦¾à¦•à¦¾ 
à§¨à§§) à¦ªà¦¾à¦Ÿà¦¿ à¦¸à¦¾à¦ªà¦Ÿà¦¾ à§§à§¦ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§¨à§¦à§¦ à¦Ÿà¦¾à¦•à¦¾
à§¨à§¨) à¦…à¦¨à§à¦¥à¦¨ à§§à§¦ à¦ªà¦¿à¦¸à§‡à¦° à¦ªà§à¦¯à¦¾à¦• à§§à§«à§¦ à¦Ÿà¦¾à¦•à¦¾ 
à§¨à§©) à¦¸à§à¦œà¦¿à¦° à¦¹à¦¾à¦²à§à¦¯à¦¼à¦¾ à§ªà§¦à§¦ à¦Ÿà¦¾à¦•à¦¾ à¦•à§‡à¦œà¦¿ 
à§¨à§ª) à¦—à¦¾à¦œà¦°à§‡à¦° à¦¹à¦¾à¦²à§à¦¯à¦¼à¦¾ à§®à§¦à§¦ à¦Ÿà¦¾à¦•à¦¾ à¦•à§‡à¦œà¦¿ 
à§¨à§«) à¦¬à§à¦Ÿà§‡à¦° à¦¹à¦¾à¦²à§à¦¯à¦¼à¦¾ à§­à§¦à§¦ à¦Ÿà¦¾à¦•à¦¾ à¦•à§‡à¦œà¦¿ 
(à¦¬à¦¿: à¦¦à§à¦°à¦ƒ à¦•à¦®à¦ªà¦•à§à¦·à§‡ à¦¯à§‡ à¦•à§‹à¦¨ à§¨ à¦ªà§à¦¯à¦¾à¦• à¦…à¦°à§à¦¡à¦¾à¦° à¦•à¦°à¦¤à§‡ à¦¹à¦¬à§‡)

## à¦ªà¦²à¦¿à¦¸à¦¿ à¦à¦¬à¦‚ à¦ªà§à¦°à¦¾à§Ÿà¦¶à¦‡ à¦œà¦¿à¦œà§à¦žà¦¾à¦¸à¦¿à¦¤ à¦ªà§à¦°à¦¶à§à¦¨ (FAQ)
- **à¦…à¦°à§à¦¡à¦¾à¦° à¦ªà§à¦°à¦¸à§‡à¦¸à¦¿à¦‚ à¦¸à¦®à§Ÿ:** à¦…à¦°à§à¦¡à¦¾à¦° à¦•à¦¨à¦«à¦¾à¦°à§à¦® à¦¹à¦“à§Ÿà¦¾à¦° à¦ªà¦° à§¨à§ª à¦¥à§‡à¦•à§‡ à§­à§¨ à¦˜à¦£à§à¦Ÿà¦¾à¦° à¦®à¦§à§à¦¯à§‡ à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦•à¦°à¦¾ à¦¹à§Ÿà¥¤ à¦à¦Ÿà¦¿ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦•à¦¾à¦œà§‡à¦° à¦šà¦¾à¦ª à¦à¦¬à¦‚ à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦²à§‹à¦•à§‡à¦¶à¦¨à§‡à¦° à¦‰à¦ªà¦° à¦¨à¦¿à¦°à§à¦­à¦° à¦•à¦°à§‡à¥¤
- **à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦à¦²à¦¾à¦•à¦¾:à¦®à¦¿à¦°à¦ªà§à¦°, à¦‰à¦¤à§à¦¤à¦°à¦¾, à¦¬à¦¸à§à¦¨à§à¦§à¦°à¦¾, à¦—à§à¦²à¦¶à¦¾à¦¨, à¦¤à§‡à¦œà¦—à¦¾à¦à¦“, à¦¬à¦¨à¦¶à§à¦°à§€ , à¦°à¦¾à¦®à¦ªà§à¦°à¦¾, à¦§à¦¾à¦¨à¦®à¦¨à§à¦¡à¦¿, à¦®à§‹à¦¹à¦¾à¦®à§à¦®à¦¦à¦ªà§à¦°, à¦†à¦œà¦¿à¦®à¦ªà§à¦°, à¦ªà¦²à§à¦Ÿà¦¨, à¦®à¦¾à¦²à¦¿à¦¬à¦¾à¦—, à¦¶à§à¦¯à¦¾à¦®à¦²à§€, à¦•à§à§œà¦¿à¦², à¦•à¦²à¦¾à¦¬à¦¾à¦—à¦¾à¦¨, à¦®à¦—à¦¬à¦¾à¦œà¦¾à¦°, à¦¨à¦¿à¦•à§à¦žà§à¦œ, à¦¬à¦¨à¦¾à¦¨à§€, à¦¬à¦¾à¦¡à§à¦¡à¦¾,  à¦à¦²à¦¾à¦•à¦¾à§Ÿ à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦•à¦°à¦¾ à¦¹à§Ÿà¥¤ à¦…à¦¨à§à¦¯à¦¾à¦¨à§à¦¯ à¦à¦²à¦¾à¦•à¦¾à¦° à¦œà¦¨à§à¦¯ à¦†à¦²à¦¾à¦¦à¦¾ à¦†à¦²à§‹à¦šà¦¨à¦¾ à¦ªà§à¦°à§Ÿà§‹à¦œà¦¨ à¦¹à¦¤à§‡ à¦ªà¦¾à¦°à§‡à¥¤
- **à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦šà¦¾à¦°à§à¦œ:** à§¬à§¦ à¦Ÿà¦¾à¦•à¦¾à¥¤  
- **à¦…à¦°à§à¦¡à¦¾à¦° à¦•à¦°à¦¾à¦° à¦¨à¦¿à§Ÿà¦®:** à¦®à§‡à¦¨à§à¦¯à§ à¦¥à§‡à¦•à§‡ à¦†à¦ªà¦¨à¦¾à¦° à¦ªà¦›à¦¨à§à¦¦à§‡à¦° à¦†à¦‡à¦Ÿà§‡à¦® à¦œà¦¾à¦¨à¦¾à¦¨à¥¤ à¦…à¦°à§à¦¡à¦¾à¦° à¦•à¦¨à¦«à¦¾à¦°à§à¦® à¦•à¦°à¦¾à¦° à¦œà¦¨à§à¦¯ à¦†à¦ªà¦¨à¦¾à¦° à¦ªà§à¦°à§‹ à¦¨à¦¾à¦®, à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦ à¦¿à¦•à¦¾à¦¨à¦¾, à¦à¦¬à¦‚ à¦à¦•à¦Ÿà¦¿ à¦¸à¦šà¦² à¦«à§‹à¦¨ à¦¨à¦®à§à¦¬à¦° à¦¦à¦¿à¦¨à¥¤
- **à¦ªà§‡à¦®à§‡à¦¨à§à¦Ÿ:** à¦†à¦®à¦°à¦¾ à¦¬à¦°à§à¦¤à¦®à¦¾à¦¨à§‡ à¦¶à§à¦§à§à¦®à¦¾à¦¤à§à¦° à¦•à§à¦¯à¦¾à¦¶ à¦…à¦¨ à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦—à§à¦°à¦¹à¦£ à¦•à¦°à¦¿à¥¤
- **à¦¯à§‹à¦—à¦¾à¦¯à§‹à¦—:** à¦¯à§‡à¦•à§‹à¦¨à§‹ à¦ªà§à¦°à§Ÿà§‹à¦œà¦¨à§‡ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦ªà§‡à¦œà§‡ à¦®à§‡à¦¸à§‡à¦œ à¦¦à¦¿à¦¨ à¦…à¦¥à¦¬à¦¾ whats app à¦¨à¦¾à¦®à§à¦¬à¦¾à¦° 0à§§à§­à§§à§«à§¯à§ªà§¬à§«à§«à§¯ à¦¨à¦®à§à¦¬à¦°à§‡ à¦•à¦² à¦•à¦°à§à¦¨à¥¤
"""

# --- à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨: Groq à¦•à§à¦²à¦¾à§Ÿà§‡à¦¨à§à¦Ÿ à¦•à¦¨à¦«à¦¿à¦—à¦¾à¦° à¦•à¦°à¦¾ ---
try:
    groq_client = Groq(api_key=GROQ_API_KEY)
    print("Groq AI à¦•à§à¦²à¦¾à§Ÿà§‡à¦¨à§à¦Ÿ à¦¸à¦«à¦²à¦­à¦¾à¦¬à§‡ à¦²à§‹à¦¡ à¦¹à§Ÿà§‡à¦›à§‡à¥¤")
except Exception as e:
    print(f"Groq AI à¦•à¦¨à¦«à¦¿à¦—à¦¾à¦°à§‡à¦¶à¦¨à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à§Ÿà§‡à¦›à§‡: {e}")
    groq_client = None

GRAPH_API_URL = 'https://graph.facebook.com/v18.0/me/messages'

@app.route('/')
def home():
    return 'à¦¸à¦¾à¦°à§à¦­à¦¾à¦°à¦Ÿà¦¿ à¦¸à¦«à¦²à¦­à¦¾à¦¬à§‡ à¦šà¦²à¦›à§‡!', 200

@app.route('/webhook', methods=['GET', 'POST'])
def webhook():
    if request.method == 'GET':
        if request.args.get('hub.verify_token') == VERIFY_TOKEN:
            return request.args.get('hub.challenge'), 200
        else:
            return 'à¦­à§‡à¦°à¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨ à¦Ÿà§‹à¦•à§‡à¦¨ à¦­à§à¦²', 403
    
    if request.method == 'POST':
        data = request.get_json()
        if data and data.get('object') == 'page':
            for entry in data.get('entry', []):
                for messaging_event in entry.get('messaging', []):
                    sender_id = messaging_event['sender']['id']
                    
                    if messaging_event.get('optin'):
                        if messaging_event['optin'].get('type') == 'one_time_notif_req':
                            otn_token = messaging_event['optin']['one_time_notif_token']
                            save_otn_token(sender_id, otn_token)
                            send_facebook_message(sender_id, "à¦§à¦¨à§à¦¯à¦¬à¦¾à¦¦! à¦†à¦®à¦°à¦¾ à¦ªà¦°à¦¬à¦°à§à¦¤à§€ à¦…à¦«à¦¾à¦° à¦à¦²à§‡ à¦†à¦ªà¦¨à¦¾à¦•à§‡ à¦œà¦¾à¦¨à¦¾à¦¬à§‹à¥¤")
                        continue

                    if messaging_event.get('message'):
                        message_text = messaging_event['message'].get('text')
                        if message_text:
                            save_message_to_db(sender_id, 'user', message_text)
                            if groq_client:
                                try:
                                    bot_response = get_groq_response(sender_id, message_text)
                                    save_message_to_db(sender_id, 'bot', bot_response)
                                    
                                    user_facing_response = bot_response
                                    
                                    if "[ORDER_CONFIRMED]" in bot_response:
                                        send_telegram_notification(bot_response)
                                        apply_date_label(sender_id)
                                        
                                        details_match = re.search(r'\[DETAILS:(.*?)\]', bot_response)
                                        if details_match:
                                            details_str = details_match.group(1)
                                            save_customer_details(sender_id, details_str)
                                        
                                        user_facing_response = re.sub(r'\[.*?\]', '', bot_response).strip()
                                        
                                        send_otn_request(sender_id)

                                    send_facebook_message(sender_id, user_facing_response)

                                except Exception as e:
                                    print(f"Groq à¦¥à§‡à¦•à§‡ à¦‰à¦¤à§à¦¤à¦° à¦†à¦¨à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à§Ÿà§‡à¦›à§‡: {e}")
                                    send_facebook_message(sender_id, "à¦¦à§à¦ƒà¦–à¦¿à¦¤, à¦à¦‡ à¦®à§à¦¹à§‚à¦°à§à¦¤à§‡ à¦‰à¦¤à§à¦¤à¦° à¦¦à¦¿à¦¤à§‡ à¦ªà¦¾à¦°à¦›à¦¿ à¦¨à¦¾à¥¤")
        return 'Event received', 200

def get_groq_response(sender_id, message):
    history = get_chat_history(sender_id)
    formatted_history = []
    for msg in history:
        if msg.get('role') and msg.get('content'):
            formatted_history.append({"role": msg.get('role'), "content": msg.get('content')})

    customer_details = get_saved_customer_details(sender_id)
    details_context = "à¦à¦‡ à¦—à§à¦°à¦¾à¦¹à¦•à§‡à¦° à¦•à§‹à¦¨à§‹ à¦¤à¦¥à§à¦¯ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦•à¦¾à¦›à§‡ à¦¸à§‡à¦­ à¦•à¦°à¦¾ à¦¨à§‡à¦‡à¥¤"
    saved_address = ""
    if customer_details and customer_details.get('address'):
        saved_address = customer_details.get('address')
        details_context = f"à¦à¦‡ à¦—à§à¦°à¦¾à¦¹à¦•à§‡à¦° à¦à¦•à¦Ÿà¦¿ à¦ à¦¿à¦•à¦¾à¦¨à¦¾ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦•à¦¾à¦›à§‡ à¦¸à§‡à¦­ à¦•à¦°à¦¾ à¦†à¦›à§‡: {saved_address}"

    system_prompt = f"""
    ### à¦†à¦ªà¦¨à¦¾à¦° à¦¬à§à¦¯à¦•à§à¦¤à¦¿à¦¤à§à¦¬ (Persona) ###
    à¦†à¦ªà¦¨à¦¿ "à¦˜à¦°à§‡à¦° à¦–à¦¾à¦¬à¦¾à¦°" à¦¹à§‹à¦®à¦®à§‡à¦¡ à¦«à§à¦°à§‹à¦œà§‡à¦¨ à¦«à§à¦¡ à¦à¦° à¦à¦•à¦œà¦¨ à¦–à§à¦¬à¦‡ à¦¹à¦¾à¦¸à¦¿à¦–à§à¦¶à¦¿, à¦¬à¦¨à§à¦§à§à¦¸à§à¦²à¦­ à¦à¦¬à¦‚ à¦¹à§‡à¦²à§à¦ªà¦«à§à¦² à¦®à¦¡à¦¾à¦°à§‡à¦Ÿà¦°à¥¤ à¦†à¦ªà¦¨à¦¾à¦° à¦•à¦¥à¦¾à¦° à¦§à¦°à¦£ à¦¹à¦¬à§‡ à¦•à¦¿à¦›à§à¦Ÿà¦¾ à¦˜à¦°à§‹à§Ÿà¦¾ à¦à¦¬à¦‚ à¦†à¦¨à§à¦¤à¦°à¦¿à¦•à¥¤ à¦†à¦ªà¦¨à¦¿ à¦¸à¦¬à¦¸à¦®à§Ÿ à¦—à§à¦°à¦¾à¦¹à¦•à¦•à§‡ à¦¸à§à¦¯à¦¾à¦°/à¦®à§à¦¯à¦¾à¦® à¦¬à¦²à§‡ à¦¸à¦®à§à¦¬à§‹à¦§à¦¨ à¦•à¦°à¦¬à§‡à¦¨à¥¤

    ### à¦†à¦ªà¦¨à¦¾à¦° à¦œà§à¦žà¦¾à¦¨ (Knowledge Base) ###
    {KNOWLEDGE_BASE}
    
    ### à¦—à§à¦°à¦¾à¦¹à¦•à§‡à¦° à¦¸à§‡à¦­ à¦•à¦°à¦¾ à¦¤à¦¥à§à¦¯ (Saved Customer Details) ###
    {details_context}

    ### à¦—à§à¦°à§à¦¤à§à¦¬à¦ªà§‚à¦°à§à¦£ à¦¨à¦¿à¦°à§à¦¦à§‡à¦¶à¦¨à¦¾ (Strict Instructions) ###
    1.  à¦•à¦¥à§‹à¦ªà¦•à¦¥à¦¨ à¦¶à§à¦°à§à¦¤à§‡à¦‡ à¦ à¦¿à¦•à¦¾à¦¨à¦¾ à¦šà¦¾à¦‡à¦¬à§‡à¦¨ à¦¨à¦¾à¥¤ à¦ªà§à¦°à¦¥à¦®à§‡ à¦—à§à¦°à¦¾à¦¹à¦•à§‡à¦° à¦‰à¦¦à§à¦¦à§‡à¦¶à§à¦¯ à¦¬à§‹à¦à¦¾à¦° à¦šà§‡à¦·à§à¦Ÿà¦¾ à¦•à¦°à§à¦¨à¥¤
    2.  à¦—à§à¦°à¦¾à¦¹à¦• à¦¯à¦–à¦¨ à¦¸à§à¦ªà¦·à§à¦Ÿà¦­à¦¾à¦¬à§‡ à¦…à¦°à§à¦¡à¦¾à¦° à¦•à¦°à¦¾à¦° à¦‡à¦šà§à¦›à¦¾ à¦ªà§à¦°à¦•à¦¾à¦¶ à¦•à¦°à¦¬à§‡, à¦¶à§à¦§à§à¦®à¦¾à¦¤à§à¦° à¦¤à¦–à¦¨à¦‡ à¦…à¦°à§à¦¡à¦¾à¦°à§‡à¦° à¦ªà§à¦°à¦•à§à¦°à¦¿à§Ÿà¦¾ à¦¶à§à¦°à§ à¦•à¦°à¦¬à§‡à¦¨à¥¤
    3.  à¦…à¦°à§à¦¡à¦¾à¦°à§‡à¦° à¦ªà§à¦°à¦•à§à¦°à¦¿à§Ÿà¦¾ à¦¶à§à¦°à§ à¦•à¦°à¦¾à¦° à¦¸à¦®à§Ÿ, à¦ªà§à¦°à¦¥à¦®à§‡ "à¦—à§à¦°à¦¾à¦¹à¦•à§‡à¦° à¦¸à§‡à¦­ à¦•à¦°à¦¾ à¦¤à¦¥à§à¦¯" à¦…à¦‚à¦¶à¦Ÿà¦¿ à¦¦à§‡à¦–à§à¦¨à¥¤
    4.  à¦¯à¦¦à¦¿ à¦¸à§‡à¦–à¦¾à¦¨à§‡ à¦•à§‹à¦¨à§‹ à¦ à¦¿à¦•à¦¾à¦¨à¦¾ à¦¸à§‡à¦­ à¦•à¦°à¦¾ à¦¥à¦¾à¦•à§‡, à¦¤à¦¾à¦¹à¦²à§‡ à¦—à§à¦°à¦¾à¦¹à¦•à¦•à§‡ à¦œà¦¿à¦œà§à¦žà§‡à¦¸ à¦•à¦°à§à¦¨ à¦“à¦‡ à¦ à¦¿à¦•à¦¾à¦¨à¦¾à§Ÿ à¦…à¦°à§à¦¡à¦¾à¦°à¦Ÿà¦¿ à¦ªà¦¾à¦ à¦¾à¦¤à§‡ à¦¹à¦¬à§‡ à¦•à¦¿à¦¨à¦¾à¥¤ à¦¯à§‡à¦®à¦¨: "à¦¸à§à¦¯à¦¾à¦°/à¦®à§à¦¯à¦¾à¦®, à¦†à¦ªà¦¨à¦¾à¦° à¦…à¦°à§à¦¡à¦¾à¦°à¦Ÿà¦¿ à¦•à¦¿ à¦†à¦ªà¦¨à¦¾à¦° à¦¸à§‡à¦­ à¦•à¦°à¦¾ à¦ à¦¿à¦•à¦¾à¦¨à¦¾ '{saved_address}' à¦à¦‡à¦–à¦¾à¦¨à§‡ à¦ªà¦¾à¦ à¦¿à§Ÿà§‡ à¦¦à§‡à¦¬à§‹?"
    5.  à¦¯à¦¦à¦¿ à¦•à§‹à¦¨à§‹ à¦ à¦¿à¦•à¦¾à¦¨à¦¾ à¦¸à§‡à¦­ à¦•à¦°à¦¾ à¦¨à¦¾ à¦¥à¦¾à¦•à§‡, à¦¤à¦¬à§‡à¦‡ à¦¶à§à¦§à§à¦®à¦¾à¦¤à§à¦° à¦—à§à¦°à¦¾à¦¹à¦•à§‡à¦° à¦•à¦¾à¦›à§‡ à¦¤à¦¾à¦° à¦ªà§à¦°à§‹ à¦¨à¦¾à¦®, à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦ à¦¿à¦•à¦¾à¦¨à¦¾, à¦à¦¬à¦‚ à¦à¦•à¦Ÿà¦¿ à¦¸à¦šà¦² à¦«à§‹à¦¨ à¦¨à¦®à§à¦¬à¦° à¦šà¦¾à¦‡à¦¬à§‡à¦¨à¥¤
    6.  à¦…à¦°à§à¦¡à¦¾à¦° à¦šà§‚à§œà¦¾à¦¨à§à¦¤à¦­à¦¾à¦¬à§‡ à¦¨à¦¿à¦¶à§à¦šà¦¿à¦¤ à¦¹à¦²à§‡, à¦†à¦ªà¦¨à¦¾à¦° à¦‰à¦¤à§à¦¤à¦°à§‡à¦° à¦¶à§à¦°à§à¦¤à§‡ à¦…à¦¬à¦¶à§à¦¯à¦‡ "[ORDER_CONFIRMED]" à¦Ÿà§à¦¯à¦¾à¦—à¦Ÿà¦¿ à¦¯à§‹à¦— à¦•à¦°à¦¬à§‡à¦¨à¥¤ à¦à¦°à¦ªà¦° à¦à¦•à¦Ÿà¦¿ à¦¨à¦¤à§à¦¨ à¦²à¦¾à¦‡à¦¨à§‡ "[DETAILS:à¦¨à¦¾à¦®=..., à¦ à¦¿à¦•à¦¾à¦¨à¦¾=..., à¦«à§‹à¦¨=...]" à¦à¦‡ à¦«à¦°à¦®à§à¦¯à¦¾à¦Ÿà§‡ à¦—à§à¦°à¦¾à¦¹à¦•à§‡à¦° à¦¸à¦®à§à¦ªà§‚à¦°à§à¦£ à¦¤à¦¥à§à¦¯ à¦¯à§‹à¦— à¦•à¦°à¦¬à§‡à¦¨à¥¤
    
    ### à¦•à¦¥à§‹à¦ªà¦•à¦¥à¦¨à§‡à¦° à¦‰à¦¦à¦¾à¦¹à¦°à¦£ (Conversation Examples) ###
    ---
    **à¦¸à§à¦¯à¦¾à¦®à§à¦ªà¦² à§§: à¦ªà§à¦°à¦¥à¦®à¦¬à¦¾à¦° à¦…à¦°à§à¦¡à¦¾à¦°**
    user: "à¦à¦•à¦Ÿà¦¾ à¦šà¦¿à¦•à§‡à¦¨ à¦¨à¦¾à¦—à§‡à¦Ÿ à¦†à¦° à¦«à§à¦°à§‡à¦žà§à¦š à¦«à§à¦°à¦¾à¦‡ à¦…à¦°à§à¦¡à¦¾à¦° à¦•à¦°à¦¤à§‡ à¦šà¦¾à¦‡à¥¤"
    (à¦¬à¦Ÿ à¦¦à§‡à¦–à¦¬à§‡ à¦•à§‹à¦¨à§‹ à¦ à¦¿à¦•à¦¾à¦¨à¦¾ à¦¸à§‡à¦­ à¦•à¦°à¦¾ à¦¨à§‡à¦‡)
    bot: "à¦…à¦¬à¦¶à§à¦¯à¦‡, à¦¸à§à¦¯à¦¾à¦°/à¦®à§à¦¯à¦¾à¦®! à¦†à¦ªà¦¨à¦¾à¦° à¦…à¦°à§à¦¡à¦¾à¦°à¦Ÿà¦¿ à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦•à¦°à¦¾à¦° à¦œà¦¨à§à¦¯ à¦¦à§Ÿà¦¾ à¦•à¦°à§‡ à¦†à¦ªà¦¨à¦¾à¦° à¦ªà§à¦°à§‹ à¦¨à¦¾à¦®, à¦¡à§‡à¦²à¦¿à¦­à¦¾à¦°à¦¿ à¦ à¦¿à¦•à¦¾à¦¨à¦¾, à¦à¦¬à¦‚ à¦à¦•à¦Ÿà¦¿ à¦¸à¦šà¦² à¦«à§‹à¦¨ à¦¨à¦®à§à¦¬à¦° à¦¦à¦¿à¦¨à¥¤"
    user: "à¦¨à¦¾à¦®: à¦†à¦•à¦¾à¦¶, à¦ à¦¿à¦•à¦¾à¦¨à¦¾: à¦®à¦¿à¦°à¦ªà§à¦° à¦¡à¦¿à¦“à¦à¦‡à¦šà¦à¦¸, à¦°à§‹à¦¡-à§§, à¦¬à¦¾à§œà¦¿-à§«, à¦¢à¦¾à¦•à¦¾à¥¤ à¦«à§‹à¦¨: à§¦à§§à§¬xxxxxxxx"
    bot: "[ORDER_CONFIRMED] [DETAILS:à¦¨à¦¾à¦®=à¦†à¦•à¦¾à¦¶, à¦ à¦¿à¦•à¦¾à¦¨à¦¾=à¦®à¦¿à¦°à¦ªà§à¦° à¦¡à¦¿à¦“à¦à¦‡à¦šà¦à¦¸, à¦°à§‹à¦¡-à§§, à¦¬à¦¾à§œà¦¿-à§«, à¦¢à¦¾à¦•à¦¾, à¦«à§‹à¦¨=à§¦à§§à§¬xxxxxxxx] à¦§à¦¨à§à¦¯à¦¬à¦¾à¦¦, à¦¸à§à¦¯à¦¾à¦°! à¦†à¦ªà¦¨à¦¾à¦° à¦…à¦°à§à¦¡à¦¾à¦°à¦Ÿà¦¿ à¦•à¦¨à¦«à¦¾à¦°à§à¦® à¦•à¦°à¦¾ à¦¹à§Ÿà§‡à¦›à§‡à¥¤ ðŸŽ‰ à¦†à¦®à¦°à¦¾ à¦¦à§à¦°à§à¦¤ à¦†à¦ªà¦¨à¦¾à¦° à¦¸à¦¾à¦¥à§‡ à¦¯à§‹à¦—à¦¾à¦¯à§‹à¦— à¦•à¦°à¦¬à¥¤"
    ---
    **à¦¸à§à¦¯à¦¾à¦®à§à¦ªà¦² à§¨: à¦°à¦¿à¦ªà¦¿à¦Ÿ à¦•à¦¾à¦¸à§à¦Ÿà¦®à¦¾à¦°**
    user: "à¦¹à¦¾à¦‡, à¦†à¦®à¦¿ à¦•à¦¿à¦›à§ à¦«à§à¦°à§‹à¦œà§‡à¦¨ à¦†à¦‡à¦Ÿà§‡à¦® à¦…à¦°à§à¦¡à¦¾à¦° à¦•à¦°à¦¤à§‡ à¦šà¦¾à¦‡à¥¤"
    (à¦¬à¦Ÿ à¦¦à§‡à¦–à¦¬à§‡ à¦ à¦¿à¦•à¦¾à¦¨à¦¾ à¦¸à§‡à¦­ à¦•à¦°à¦¾ à¦†à¦›à§‡)
    bot: "à¦†à¦ªà¦¨à¦¾à¦•à§‡ à¦†à¦¬à¦¾à¦° à¦¸à§à¦¬à¦¾à¦—à¦¤, à¦¸à§à¦¯à¦¾à¦°/à¦®à§à¦¯à¦¾à¦®! ðŸ˜Š à¦…à¦¬à¦¶à§à¦¯à¦‡ à¦…à¦°à§à¦¡à¦¾à¦° à¦•à¦°à¦¤à§‡ à¦ªà¦¾à¦°à¦¬à§‡à¦¨à¥¤ à¦†à¦ªà¦¨à¦¾à¦° à¦…à¦°à§à¦¡à¦¾à¦°à¦Ÿà¦¿ à¦•à¦¿ à¦†à¦ªà¦¨à¦¾à¦° à¦¸à§‡à¦­ à¦•à¦°à¦¾ à¦ à¦¿à¦•à¦¾à¦¨à¦¾ 'à¦®à¦¿à¦°à¦ªà§à¦° à¦¡à¦¿à¦“à¦à¦‡à¦šà¦à¦¸, à¦°à§‹à¦¡-à§§, à¦¬à¦¾à§œà¦¿-à§«, à¦¢à¦¾à¦•à¦¾' à¦à¦‡à¦–à¦¾à¦¨à§‡ à¦ªà¦¾à¦ à¦¿à§Ÿà§‡ à¦¦à§‡à¦¬à§‹?"
    user: "à¦¹à§à¦¯à¦¾à¦, à¦“à¦‡ à¦ à¦¿à¦•à¦¾à¦¨à¦¾à¦¤à§‡à¦‡ à¦ªà¦¾à¦ à¦¾à¦¨à¥¤"
    bot: "[ORDER_CONFIRMED] [DETAILS:à¦¨à¦¾à¦®=à¦†à¦•à¦¾à¦¶, à¦ à¦¿à¦•à¦¾à¦¨à¦¾=à¦®à¦¿à¦°à¦ªà§à¦° à¦¡à¦¿à¦“à¦à¦‡à¦šà¦à¦¸, à¦°à§‹à¦¡-à§§, à¦¬à¦¾à§œà¦¿-à§«, à¦¢à¦¾à¦•à¦¾, à¦«à§‹à¦¨=à§¦à§§à§¬xxxxxxxx] à¦§à¦¨à§à¦¯à¦¬à¦¾à¦¦, à¦¸à§à¦¯à¦¾à¦°! à¦†à¦ªà¦¨à¦¾à¦° à¦…à¦°à§à¦¡à¦¾à¦°à¦Ÿà¦¿ à¦†à¦ªà¦¨à¦¾à¦° à¦¸à§‡à¦­ à¦•à¦°à¦¾ à¦ à¦¿à¦•à¦¾à¦¨à¦¾à¦° à¦œà¦¨à§à¦¯ à¦•à¦¨à¦«à¦¾à¦°à§à¦® à¦•à¦°à¦¾ à¦¹à§Ÿà§‡à¦›à§‡à¥¤ à¦†à¦° à¦•à¦¿à¦›à§ à¦•à¦¿ à¦²à¦¾à¦—à¦¬à§‡ à¦†à¦ªà¦¨à¦¾à¦°?"
    ---
    """
    
    messages_for_api = [
        {"role": "system", "content": system_prompt}
    ]
    messages_for_api.extend(formatted_history)
    messages_for_api.append({"role": "user", "content": message})

    try:
        chat_completion = groq_client.chat.completions.create(
            messages=messages_for_api,
            model="llama3-8b-8192",
        )
        return chat_completion.choices[0].message.content
    except Exception as e:
        print(f"Groq API Error: {e}")
        return "à¦¦à§à¦ƒà¦–à¦¿à¦¤, à¦à¦•à¦Ÿà¦¿ à¦ªà§à¦°à¦¯à§à¦•à§à¦¤à¦¿à¦—à¦¤ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à§Ÿà§‡à¦›à§‡à¥¤ à¦†à¦®à¦°à¦¾ à¦¬à¦¿à¦·à§Ÿà¦Ÿà¦¿ à¦¦à§‡à¦–à¦›à¦¿à¥¤"

def save_customer_details(sender_id, details_str):
    try:
        details = dict(item.split("=") for item in details_str.strip().split(", "))
        if client:
            customer_details_collection.update_one(
                {'sender_id': sender_id},
                {'$set': {
                    'name': details.get('à¦¨à¦¾à¦®'),
                    'address': details.get('à¦ à¦¿à¦•à¦¾à¦¨à¦¾'),
                    'phone': details.get('à¦«à§‹à¦¨'),
                    'last_updated': datetime.utcnow()
                }},
                upsert=True
            )
            print(f"à¦—à§à¦°à¦¾à¦¹à¦• {sender_id}-à¦à¦° à¦¤à¦¥à§à¦¯ à¦¸à§‡à¦­/à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à¦¾ à¦¹à§Ÿà§‡à¦›à§‡à¥¤")
    except Exception as e:
        print(f"à¦—à§à¦°à¦¾à¦¹à¦•à§‡à¦° à¦¤à¦¥à§à¦¯ à¦ªà¦¾à¦°à§à¦¸ à¦¬à¦¾ à¦¸à§‡à¦­ à¦•à¦°à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾: {e}")

def get_saved_customer_details(sender_id):
    if client:
        details = customer_details_collection.find_one({'sender_id': sender_id})
        if details:
             return details
    return None

def save_message_to_db(sender_id, role, content):
    if client:
        chat_history_collection.insert_one({
            'sender_id': sender_id,
            'role': role,
            'content': content,
            'timestamp': datetime.utcnow()
        })

def get_chat_history(sender_id, limit=5):
    if client:
        history_cursor = chat_history_collection.find({'sender_id': sender_id}).sort('timestamp', -1).limit(limit)
        return list(history_cursor)[::-1]
    return []

def send_otn_request(recipient_id):
    params = {'access_token': FACEBOOK_PAGE_ACCESS_TOKEN}
    headers = {'Content-Type': 'application/json'}
    data = {
        'recipient': {'id': recipient_id},
        'message': {
            "attachment": {
                "type": "template",
                "payload": {
                    "template_type": "one_time_notif_req",
                    "title": "à¦†à¦®à¦¾à¦¦à§‡à¦° à¦ªà¦°à¦¬à¦°à§à¦¤à§€ à¦…à¦«à¦¾à¦° à¦¸à¦®à§à¦ªà¦°à§à¦•à§‡ à¦œà¦¾à¦¨à¦¤à§‡ à¦šà¦¾à¦¨?",
                    "payload": "notify_me_payload" 
                }
            }
        }
    }
    requests.post(GRAPH_API_URL, params=params, headers=headers, json=data)

def send_telegram_notification(order_details):
    if not TELEGRAM_USERNAME or not CALLMEBOT_API_KEY:
        print("Telegram à¦¨à§‹à¦Ÿà¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨à§‡à¦° à¦œà¦¨à§à¦¯ à¦ªà§à¦°à§Ÿà§‹à¦œà¦¨à§€à§Ÿ à¦¤à¦¥à§à¦¯ à¦¸à§‡à¦Ÿ à¦•à¦°à¦¾ à¦¨à§‡à¦‡à¥¤")
        return
    message_body = f"*à¦¨à¦¤à§à¦¨ à¦…à¦°à§à¦¡à¦¾à¦° à¦à¦¸à§‡à¦›à§‡!*\n\n{order_details.replace('[ORDER_CONFIRMED]', '').strip()}"
    encoded_message = urllib.parse.quote_plus(message_body)
    api_url = f"https://api.callmebot.com/text.php?user={TELEGRAM_USERNAME}&text={encoded_message}&apikey={CALLMEBOT_API_KEY}"
    try:
        response = requests.get(api_url, timeout=10)
        if response.status_code == 200:
            print("à¦¸à¦«à¦²à¦­à¦¾à¦¬à§‡ Telegram à¦¨à§‹à¦Ÿà¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨ à¦ªà¦¾à¦ à¦¾à¦¨à§‹ à¦¹à§Ÿà§‡à¦›à§‡à¥¤")
        else:
            print(f"Telegram à¦¨à§‹à¦Ÿà¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨ à¦ªà¦¾à¦ à¦¾à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à§Ÿà§‡à¦›à§‡: {response.text}")
    except requests.exceptions.RequestException as e:
        print(f"CallMeBot API-à¦¤à§‡ à¦•à¦² à¦•à¦°à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à§Ÿà§‡à¦›à§‡: {e}")

def get_or_create_label_id(label_name):
    get_labels_url = f"https://graph.facebook.com/v18.0/me/custom_labels"
    params = {'fields': 'name', 'access_token': FACEBOOK_PAGE_ACCESS_TOKEN}
    try:
        response = requests.get(get_labels_url, params=params, timeout=10)
        response.raise_for_status()
        existing_labels = response.json().get('data', [])
        for label in existing_labels:
            if label.get('name') == label_name:
                return label.get('id')
        create_label_url = f"https://graph.facebook.com/v18.0/me/custom_labels"
        data = {'name': label_name}
        response = requests.post(create_label_url, params={'access_token': FACEBOOK_PAGE_ACCESS_TOKEN}, json=data, timeout=10)
        response.raise_for_status()
        new_label = response.json()
        return new_label.get('id')
    except requests.exceptions.RequestException as e:
        print(f"à¦²à§‡à¦¬à§‡à¦² à¦¤à§ˆà¦°à¦¿ à¦¬à¦¾ à¦–à§à¦à¦œà¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à§Ÿà§‡à¦›à§‡: {e}")
        return None

def apply_date_label(user_psid):
    today_label_name = datetime.now().strftime("%d-%m-%Y")
    label_id = get_or_create_label_id(today_label_name)
    if not label_id:
        return
    apply_label_url = f"https://graph.facebook.com/v18.0/{label_id}/label"
    params = {'user': user_psid, 'access_token': FACEBOOK_PAGE_ACCESS_TOKEN}
    try:
        response = requests.post(apply_label_url, params=params, timeout=10)
        response.raise_for_status()
        if response.json().get('success'):
            print(f"à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦°à¦•à¦¾à¦°à§€ {user_psid}-à¦•à§‡ à¦¸à¦«à¦²à¦­à¦¾à¦¬à§‡ '{today_label_name}' à¦²à§‡à¦¬à§‡à¦² à¦¦à§‡à¦“à§Ÿà¦¾ à¦¹à§Ÿà§‡à¦›à§‡à¥¤")
    except requests.exceptions.RequestException as e:
        print(f"à¦«à§‡à¦¸à¦¬à§à¦• à¦²à§‡à¦¬à§‡à¦² API-à¦¤à§‡ à¦•à¦² à¦•à¦°à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à§Ÿà§‡à¦›à§‡: {e}")

def send_facebook_message(recipient_id, message_text):
    params = {'access_token': FACEBOOK_PAGE_ACCESS_TOKEN}
    headers = {'Content-Type': 'application/json'}
    data = {
        'recipient': {'id': recipient_id},
        'message': {'text': message_text},
        'messaging_type': 'RESPONSE'
    }
    try:
        requests.post(GRAPH_API_URL, params=params, headers=headers, json=data, timeout=10)
    except requests.exceptions.RequestException as e:
        print(f"à¦«à§‡à¦¸à¦¬à§à¦•à§‡ à¦®à§‡à¦¸à§‡à¦œ à¦ªà¦¾à¦ à¦¾à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à§Ÿà§‡à¦›à§‡: {e}")

