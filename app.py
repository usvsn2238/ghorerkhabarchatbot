import os
import requests
from flask import Flask, request
from dotenv import load_dotenv
import urllib.parse
from datetime import datetime
from pymongo import MongoClient
import re
from groq import Groq

# .env ржлрж╛ржЗрж▓ ржерзЗржХрзЗ Environment Variables рж▓рзЛржб ржХрж░рж╛рж░ ржЬржирзНржп
load_dotenv()

# Flask ржЕрзНржпрж╛ржк ржЗржирж┐рж╢рж┐рзЯрж╛рж▓рж╛ржЗржЬ ржХрж░рж╛
app = Flask(__name__)

# Environment Variables ржерзЗржХрзЗ Key ржПржмржВ Token ржЧрзБрж▓рзЛ ржирзЗржУрзЯрж╛
FACEBOOK_PAGE_ACCESS_TOKEN = os.getenv('FACEBOOK_PAGE_ACCESS_TOKEN')
VERIFY_TOKEN = os.getenv('VERIFY_TOKEN')
GROQ_API_KEY = os.getenv('GROQ_API_KEY')
MONGO_URI = os.getenv('MONGO_URI')
TELEGRAM_USERNAME = os.getenv('TELEGRAM_USERNAME')
CALLMEBOT_API_KEY = os.getenv('CALLMEBOT_API_KEY')

# --- ржбрзЗржЯрж╛ржмрзЗрж╕ ржХрж╛ржирзЗржХрж╢ржи ---
try:
    client = MongoClient(MONGO_URI)
    db = client.chatbot_db
    chat_history_collection = db.chat_history
    otn_tokens_collection = db.otn_tokens
    customer_details_collection = db.customer_details
    print("MongoDB ржбрзЗржЯрж╛ржмрзЗрж╕рзЗрж░ рж╕рж╛ржерзЗ рж╕ржлрж▓ржнрж╛ржмрзЗ рж╕ржВржпрзБржХрзНрждред")
except Exception as e:
    print(f"MongoDB рж╕ржВржпрзЛржЧрзЗ рж╕ржорж╕рзНржпрж╛: {e}")
    client = None
# -------------------------

KNOWLEDGE_BASE = """
# --- ржЖржорж╛рж░ рж╣рзЛржоржорзЗржб ржлрзНрж░рзЛржЬрзЗржи ржлрзБржб ржПрж░ рждржерзНржп ---
 
## ржЖржорж╛ржжрзЗрж░ рж╕ржорзНржкрж░рзНржХрзЗ
ржЖржорж░рж╛ "ржШрж░рзЗрж░ ржЦрж╛ржмрж╛рж░" рж╕ржорзНржкрзБрж░рзНржи ржмрж╛рж╕рж╛рзЯ ржЕрждрзНржпржирзНржд ржкрж░ржЪрзНржЫржирзНржиржнрж╛ржмрзЗ ржлрзНрж░рзЛржЬрзЗржи ржлрзБржб рждрзИрж░рж┐ ржХрж░рзЗ ржерж╛ржХрж┐ред ржЖржорж╛рж░рж╛ ржЕржирж▓рж╛ржЗржи ржЕрж░рзНржбрж╛рж░ ржПржмржВ ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ рж╕рзЗржмрж╛ ржжрж┐рзЯрзЗ ржерж╛ржХрж┐ред ржЖржорж╛ржжрзЗрж░ ржкрзНрж░ржзрж╛ржи рж▓ржХрзНрж╖рзНржп рж╣рж▓рзЛ ржЧрзНрж░рж╛рж╣ржХржжрзЗрж░ рж╕рзБрж╕рзНржмрж╛ржжрзБ ржПржмржВ рж╕рзНржмрж╛рж╕рзНржерзНржпржХрж░ ржЦрж╛ржмрж╛рж░ рж╕рж░ржмрж░рж╛рж╣ ржХрж░рж╛ред
## ржорзЗржирзНржпрзБ рж▓рж┐рж╕рзНржЯ
### ржЖрж╕рж╕рж╛рж▓рж╛ржорзБ ржЖрж▓рж╛ржЗржХрзБржо 
ржЖржкржирж╛ржжрзЗрж░ ржЬржирзНржп ржирж┐рзЯрзЗ ржПрж╕рзЗржЫрж┐ рж╕рзБрж╕рзНржмрж╛ржжрзБ ржПржмржВ рж╕рзНржмрж╛рж╕рзНржерзНржпржХрж░ ржлрзНрж░рзЛржЬрзЗржи ржлрзБржбрзЗрж░ ржорзЗржирзНржпрзБред ржирж┐ржЪрзЗ ржЖржорж╛ржжрзЗрж░ ржорзЗржирзНржпрзБ рж▓рж┐рж╕рзНржЯ ржжрзЗржУрзЯрж╛ рж╣рж▓рзЛ:
рзз) ржЪрж┐ржХрзЗржи рж░рзЛрж▓ рззрзл ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ    рзирзирзл ржЯрж╛ржХрж╛
рзи) ржнрзЗржЬрж┐ржЯрзЗржмрж▓ рж░рзЛрж▓ рззрзл ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рззрзлрзж ржЯрж╛ржХрж╛
рзй) ржмрж┐ржл рж░рзЛрж▓ рззрзж ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рзирзлрзж ржЯрж╛ржХрж╛ 
рзк) ржЪрж┐ржХрзЗржи рж╕ржорзБржЪрж╛ рззрзл ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рзирзирзл ржЯрж╛ржХрж╛ 
рзл) ржнрзЗржЬрж┐ржЯрзЗржмрж▓ рж╕ржорзБржЪрж╛ рззрзл ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рззрзлрзж ржЯрж╛ржХрж╛ 
рзм) ржмрж┐ржл рж╕ржорзБржЪрж╛ рззрзж ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рзирзлрзж ржЯрж╛ржХрж╛ 
рзн) ржЪрж┐ржХрзЗржи рж╕рж┐ржЩрзНржЧрж╛рж░рж╛ рззрзж ржкрж┐рж╕рзЗрж░  ржкрзНржпрж╛ржХ рззрзлрзж ржЯрж╛ржХрж╛ 
рзо) ржЖрж▓рзБ рж╕рж┐ржЩрзНржЧрж╛рж░рж╛ рззрзж ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рззрзжрзж ржЯрж╛ржХрж╛ 
рзп) ржЪрж┐ржХрзЗржи ржХрж▓рж┐ржЬрж╛ рж╕рж┐ржЩрзНржЧрж╛рж░рж╛ рззрзж ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рззрзмрзж ржЯрж╛ржХрж╛ ред
рззрзж) ржЖрж▓рзБ ржкрзБрж░рж┐  рзирзж ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рззрзмрзж ржЯрж╛ржХрж╛ 
рззрзз) ржбрж╛рж▓ ржкрзБрж░рж┐ рзирзж ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рззрзмрзж ржЯрж╛ржХрж╛ 
рззрзи) ржЪрж┐ржХрзЗржи ржирж╛ржЧрзЗржЯрж╕ рззрзи ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рзирзкрзж ржЯрж╛ржХрж╛ 
рззрзй) ржЪрж┐ржХрзЗржи ржЯрж┐ржХрж┐ржпрж╝рж╛ ржХрж╛ржмрж╛ржм рззрзи ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рзирзкрзж ржЯрж╛ржХрж╛
рззрзк) ржЪрж┐ржХрзЗржи ржЭрж╛рж▓ ржбрзЛржирж╛ржЯ  рззрзи ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рзирзкрзж ржЯрж╛ржХрж╛
рззрзл) ржЪрж┐ржХрзЗржи ржХрж╛ржЯрж▓рзЗржЯ рззрзи ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рзирзкрзж ржЯрж╛ржХрж╛ ред 
рззрзм) ржЪрж╛рж░ржХрзЛржирж╛ ржкрж░рзЛржЯрж╛  
      ржХ)рзирзж ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ(рззрзирзжрзжgm )220ржЯрж╛ржХрж╛ ред
      ржЦ)рзирзж ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ (рззрзлрзжрзж gm) 260ржЯрж╛ржХрж╛ред
      ржЧ) рззрзж ржкрж┐рж╕ ржЖрж▓рзБ ржкрж░рзЛржЯрж╛ рзирзлрзж ржЯрж╛ржХрж╛

рззрзн) ржЖржЯрж╛ рж░рзБржЯрж┐ рзирзж ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рззрзмрзж ржЯрж╛ржХрж╛ 
рззрзо) ржоржпрж╝ржжрж╛ рж░рзБржЯрж┐ рзирзж ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рззрзорзж ржЯрж╛ржХрж╛ 
рззрзп) рж▓рж╛рж▓ ржЖржЯрж╛ рж░рзБржЯрж┐  рзирзж ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рззрзорзж ржЯрж╛ржХрж╛ 
рзирзж) ржЪрж╛ржЙрж▓рзЗрж░ рж░рзБржЯрж┐ рзирзж ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ 200 ржЯрж╛ржХрж╛ 
рзирзз) ржкрж╛ржЯрж┐ рж╕рж╛ржкржЯрж╛ рззрзж ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рзирзжрзж ржЯрж╛ржХрж╛
рзирзи) ржЕржирзНржержи рззрзж ржкрж┐рж╕рзЗрж░ ржкрзНржпрж╛ржХ рззрзлрзж ржЯрж╛ржХрж╛ 
рзирзй) рж╕рзБржЬрж┐рж░ рж╣рж╛рж▓рзБржпрж╝рж╛ рзкрзжрзж ржЯрж╛ржХрж╛ ржХрзЗржЬрж┐ 
рзирзк) ржЧрж╛ржЬрж░рзЗрж░ рж╣рж╛рж▓рзБржпрж╝рж╛ рзорзжрзж ржЯрж╛ржХрж╛ ржХрзЗржЬрж┐ 
рзирзл) ржмрзБржЯрзЗрж░ рж╣рж╛рж▓рзБржпрж╝рж╛ рзнрзжрзж ржЯрж╛ржХрж╛ ржХрзЗржЬрж┐ 
(ржмрж┐: ржжрзНрж░ржГ ржХржоржкржХрзНрж╖рзЗ ржпрзЗ ржХрзЛржи рзи ржкрзНржпрж╛ржХ ржЕрж░рзНржбрж╛рж░ ржХрж░рждрзЗ рж╣ржмрзЗ)

## ржкрж▓рж┐рж╕рж┐ ржПржмржВ ржкрзНрж░рж╛рзЯрж╢ржЗ ржЬрж┐ржЬрзНржЮрж╛рж╕рж┐ржд ржкрзНрж░рж╢рзНржи (FAQ)
- **ржЕрж░рзНржбрж╛рж░ ржкрзНрж░рж╕рзЗрж╕рж┐ржВ рж╕ржорзЯ:** ржЕрж░рзНржбрж╛рж░ ржХржиржлрж╛рж░рзНржо рж╣ржУрзЯрж╛рж░ ржкрж░ рзирзк ржерзЗржХрзЗ рзнрзи ржШржгрзНржЯрж╛рж░ ржоржзрзНржпрзЗ ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ ржХрж░рж╛ рж╣рзЯред ржПржЯрж┐ ржЖржорж╛ржжрзЗрж░ ржХрж╛ржЬрзЗрж░ ржЪрж╛ржк ржПржмржВ ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ рж▓рзЛржХрзЗрж╢ржирзЗрж░ ржЙржкрж░ ржирж┐рж░рзНржнрж░ ржХрж░рзЗред
- **ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ ржПрж▓рж╛ржХрж╛:ржорж┐рж░ржкрзБрж░, ржЙрждрзНрждрж░рж╛, ржмрж╕рзБржирзНржзрж░рж╛, ржЧрзБрж▓рж╢рж╛ржи, рждрзЗржЬржЧрж╛ржБржУ, ржмржирж╢рзНрж░рзА , рж░рж╛ржоржкрзБрж░рж╛, ржзрж╛ржиржоржирзНржбрж┐, ржорзЛрж╣рж╛ржорзНржоржжржкрзБрж░, ржЖржЬрж┐ржоржкрзБрж░, ржкрж▓рзНржЯржи, ржорж╛рж▓рж┐ржмрж╛ржЧ, рж╢рзНржпрж╛ржорж▓рзА, ржХрзБрзЬрж┐рж▓, ржХрж▓рж╛ржмрж╛ржЧрж╛ржи, ржоржЧржмрж╛ржЬрж╛рж░, ржирж┐ржХрзБржЮрзНржЬ, ржмржирж╛ржирзА, ржмрж╛ржбрзНржбрж╛,  ржПрж▓рж╛ржХрж╛рзЯ ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ ржХрж░рж╛ рж╣рзЯред ржЕржирзНржпрж╛ржирзНржп ржПрж▓рж╛ржХрж╛рж░ ржЬржирзНржп ржЖрж▓рж╛ржжрж╛ ржЖрж▓рзЛржЪржирж╛ ржкрзНрж░рзЯрзЛржЬржи рж╣рждрзЗ ржкрж╛рж░рзЗред
- **ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ ржЪрж╛рж░рзНржЬ:** рзмрзж ржЯрж╛ржХрж╛ред  
- **ржЕрж░рзНржбрж╛рж░ ржХрж░рж╛рж░ ржирж┐рзЯржо:** ржорзЗржирзНржпрзБ ржерзЗржХрзЗ ржЖржкржирж╛рж░ ржкржЫржирзНржжрзЗрж░ ржЖржЗржЯрзЗржо ржЬрж╛ржирж╛ржиред ржЕрж░рзНржбрж╛рж░ ржХржиржлрж╛рж░рзНржо ржХрж░рж╛рж░ ржЬржирзНржп ржЖржкржирж╛рж░ ржкрзБрж░рзЛ ржирж╛ржо, ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ ржарж┐ржХрж╛ржирж╛, ржПржмржВ ржПржХржЯрж┐ рж╕ржЪрж▓ ржлрзЛржи ржиржорзНржмрж░ ржжрж┐ржиред
- **ржкрзЗржорзЗржирзНржЯ:** ржЖржорж░рж╛ ржмрж░рзНрждржорж╛ржирзЗ рж╢рзБржзрзБржорж╛рждрзНрж░ ржХрзНржпрж╛рж╢ ржЕржи ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ ржЧрзНрж░рж╣ржг ржХрж░рж┐ред
- **ржпрзЛржЧрж╛ржпрзЛржЧ:** ржпрзЗржХрзЛржирзЛ ржкрзНрж░рзЯрзЛржЬржирзЗ ржЖржорж╛ржжрзЗрж░ ржкрзЗржЬрзЗ ржорзЗрж╕рзЗржЬ ржжрж┐ржи ржЕржержмрж╛ whats app ржирж╛ржорзНржмрж╛рж░ 0рззрзнрззрзлрзпрзкрзмрзлрзлрзп ржиржорзНржмрж░рзЗ ржХрж▓ ржХрж░рзБржиред
"""

# Groq ржХрзНрж▓рж╛рзЯрзЗржирзНржЯ ржХржиржлрж┐ржЧрж╛рж░ ржХрж░рж╛
try:
    groq_client = Groq(api_key=GROQ_API_KEY)
    print("Groq AI ржХрзНрж▓рж╛рзЯрзЗржирзНржЯ рж╕ржлрж▓ржнрж╛ржмрзЗ рж▓рзЛржб рж╣рзЯрзЗржЫрзЗред")
except Exception as e:
    print(f"Groq AI ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржирзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗ: {e}")
    groq_client = None

GRAPH_API_URL = 'https://graph.facebook.com/v18.0/me/messages'

@app.route('/')
def home():
    return 'рж╕рж╛рж░рзНржнрж╛рж░ржЯрж┐ рж╕ржлрж▓ржнрж╛ржмрзЗ ржЪрж▓ржЫрзЗ!', 200

@app.route('/webhook', methods=['GET', 'POST'])
def webhook():
    if request.method == 'GET':
        if request.args.get('hub.verify_token') == VERIFY_TOKEN:
            return request.args.get('hub.challenge'), 200
        else:
            return 'ржнрзЗрж░рж┐ржлрж┐ржХрзЗрж╢ржи ржЯрзЛржХрзЗржи ржнрзБрж▓', 403
    
    if request.method == 'POST':
        data = request.get_json()
        if data and data.get('object') == 'page':
            for entry in data.get('entry', []):
                for messaging_event in entry.get('messaging', []):
                    sender_id = messaging_event['sender']['id']
                    
                    if messaging_event.get('optin'):
                        if messaging_event['optin'].get('type') == 'one_time_notif_req':
                            otn_token = messaging_event['optin']['one_time_notif_token']
                            save_otn_token(sender_id, otn_token)
                            send_facebook_message(sender_id, "ржзржирзНржпржмрж╛ржж! ржЖржорж░рж╛ ржкрж░ржмрж░рзНрждрзА ржЕржлрж╛рж░ ржПрж▓рзЗ ржЖржкржирж╛ржХрзЗ ржЬрж╛ржирж╛ржмрзЛред")
                        continue

                    if messaging_event.get('message'):
                        message_text = messaging_event['message'].get('text')
                        if message_text:
                            save_message_to_db(sender_id, 'user', message_text)
                            if groq_client:
                                try:
                                    bot_response = get_groq_response(sender_id, message_text)
                                    save_message_to_db(sender_id, 'bot', bot_response)
                                    
                                    user_facing_response = bot_response
                                    
                                    if "[ORDER_CONFIRMED]" in bot_response:
                                        send_telegram_notification(bot_response)
                                        apply_date_label(sender_id)
                                        
                                        details_match = re.search(r'\[DETAILS:(.*?)\]', bot_response)
                                        if details_match:
                                            details_str = details_match.group(1)
                                            save_customer_details(sender_id, details_str)
                                        
                                        user_facing_response = re.sub(r'\[.*?\]', '', bot_response).strip()
                                        
                                        send_otn_request(sender_id)

                                    send_facebook_message(sender_id, user_facing_response)

                                except Exception as e:
                                    print(f"Groq ржерзЗржХрзЗ ржЙрждрзНрждрж░ ржЖржирждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗ: {e}")
                                    send_facebook_message(sender_id, "ржжрзБржГржЦрж┐ржд, ржПржЗ ржорзБрж╣рзВрж░рзНрждрзЗ ржЙрждрзНрждрж░ ржжрж┐рждрзЗ ржкрж╛рж░ржЫрж┐ ржирж╛ред")
        return 'Event received', 200

def get_groq_response(sender_id, message):
    history = get_chat_history(sender_id)
    formatted_history = []
    for msg in history:
        if msg.get('role') and msg.get('content'):
            formatted_history.append({"role": msg.get('role'), "content": msg.get('content')})

    customer_details = get_saved_customer_details(sender_id)
    details_context = "ржПржЗ ржЧрзНрж░рж╛рж╣ржХрзЗрж░ ржХрзЛржирзЛ рждржерзНржп ржЖржорж╛ржжрзЗрж░ ржХрж╛ржЫрзЗ рж╕рзЗржн ржХрж░рж╛ ржирзЗржЗред"
    saved_address = ""
    if customer_details and customer_details.get('address'):
        saved_address = customer_details.get('address')
        details_context = f"ржПржЗ ржЧрзНрж░рж╛рж╣ржХрзЗрж░ ржПржХржЯрж┐ ржарж┐ржХрж╛ржирж╛ ржЖржорж╛ржжрзЗрж░ ржХрж╛ржЫрзЗ рж╕рзЗржн ржХрж░рж╛ ржЖржЫрзЗ: {saved_address}"

    system_prompt = f"""
    ### ржЖржкржирж╛рж░ ржмрзНржпржХрзНрждрж┐рждрзНржм (Persona) ###
    ржЖржкржирж┐ "ржШрж░рзЗрж░ ржЦрж╛ржмрж╛рж░" рж╣рзЛржоржорзЗржб ржлрзНрж░рзЛржЬрзЗржи ржлрзБржб ржПрж░ ржПржХржЬржи ржЦрзБржмржЗ рж╣рж╛рж╕рж┐ржЦрзБрж╢рж┐, ржмржирзНржзрзБрж╕рзБрж▓ржн ржПржмржВ рж╣рзЗрж▓рзНржкржлрзБрж▓ ржоржбрж╛рж░рзЗржЯрж░ред ржЖржкржирж╛рж░ ржХржерж╛рж░ ржзрж░ржг рж╣ржмрзЗ ржХрж┐ржЫрзБржЯрж╛ ржШрж░рзЛрзЯрж╛ ржПржмржВ ржЖржирзНрждрж░рж┐ржХред ржЖржкржирж┐ рж╕ржмрж╕ржорзЯ ржЧрзНрж░рж╛рж╣ржХржХрзЗ рж╕рзНржпрж╛рж░/ржорзНржпрж╛ржо ржмрж▓рзЗ рж╕ржорзНржмрзЛржзржи ржХрж░ржмрзЗржиред

    ### ржЖржкржирж╛рж░ ржЬрзНржЮрж╛ржи (Knowledge Base) ###
    {KNOWLEDGE_BASE}
    
    ### ржЧрзНрж░рж╛рж╣ржХрзЗрж░ рж╕рзЗржн ржХрж░рж╛ рждржерзНржп (Saved Customer Details) ###
    {details_context}

    ### ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржирж┐рж░рзНржжрзЗрж╢ржирж╛ (Strict Instructions) ###
    1.  ржХржерзЛржкржХржержи рж╢рзБрж░рзБрждрзЗржЗ ржарж┐ржХрж╛ржирж╛ ржЪрж╛ржЗржмрзЗржи ржирж╛ред ржкрзНрж░ржержорзЗ ржЧрзНрж░рж╛рж╣ржХрзЗрж░ ржЙржжрзНржжрзЗрж╢рзНржп ржмрзЛржЭрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржиред
    2.  ржЧрзНрж░рж╛рж╣ржХ ржпржЦржи рж╕рзНржкрж╖рзНржЯржнрж╛ржмрзЗ ржЕрж░рзНржбрж╛рж░ ржХрж░рж╛рж░ ржЗржЪрзНржЫрж╛ ржкрзНрж░ржХрж╛рж╢ ржХрж░ржмрзЗ, рж╢рзБржзрзБржорж╛рждрзНрж░ рждржЦржиржЗ ржЕрж░рзНржбрж╛рж░рзЗрж░ ржкрзНрж░ржХрзНрж░рж┐рзЯрж╛ рж╢рзБрж░рзБ ржХрж░ржмрзЗржиред
    3.  ржЕрж░рзНржбрж╛рж░рзЗрж░ ржкрзНрж░ржХрзНрж░рж┐рзЯрж╛ рж╢рзБрж░рзБ ржХрж░рж╛рж░ рж╕ржорзЯ, ржкрзНрж░ржержорзЗ "ржЧрзНрж░рж╛рж╣ржХрзЗрж░ рж╕рзЗржн ржХрж░рж╛ рждржерзНржп" ржЕржВрж╢ржЯрж┐ ржжрзЗржЦрзБржиред
    4.  ржпржжрж┐ рж╕рзЗржЦрж╛ржирзЗ ржХрзЛржирзЛ ржарж┐ржХрж╛ржирж╛ рж╕рзЗржн ржХрж░рж╛ ржерж╛ржХрзЗ, рждрж╛рж╣рж▓рзЗ ржЧрзНрж░рж╛рж╣ржХржХрзЗ ржЬрж┐ржЬрзНржЮрзЗрж╕ ржХрж░рзБржи ржУржЗ ржарж┐ржХрж╛ржирж╛рзЯ ржЕрж░рзНржбрж╛рж░ржЯрж┐ ржкрж╛ржарж╛рждрзЗ рж╣ржмрзЗ ржХрж┐ржирж╛ред ржпрзЗржоржи: "рж╕рзНржпрж╛рж░/ржорзНржпрж╛ржо, ржЖржкржирж╛рж░ ржЕрж░рзНржбрж╛рж░ржЯрж┐ ржХрж┐ ржЖржкржирж╛рж░ рж╕рзЗржн ржХрж░рж╛ ржарж┐ржХрж╛ржирж╛ '{saved_address}' ржПржЗржЦрж╛ржирзЗ ржкрж╛ржарж┐рзЯрзЗ ржжрзЗржмрзЛ?"
    5.  ржпржжрж┐ ржХрзЛржирзЛ ржарж┐ржХрж╛ржирж╛ рж╕рзЗржн ржХрж░рж╛ ржирж╛ ржерж╛ржХрзЗ, рждржмрзЗржЗ рж╢рзБржзрзБржорж╛рждрзНрж░ ржЧрзНрж░рж╛рж╣ржХрзЗрж░ ржХрж╛ржЫрзЗ рждрж╛рж░ ржкрзБрж░рзЛ ржирж╛ржо, ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ ржарж┐ржХрж╛ржирж╛, ржПржмржВ ржПржХржЯрж┐ рж╕ржЪрж▓ ржлрзЛржи ржиржорзНржмрж░ ржЪрж╛ржЗржмрзЗржиред
    6.  ржЕрж░рзНржбрж╛рж░ ржЪрзВрзЬрж╛ржирзНрждржнрж╛ржмрзЗ ржирж┐рж╢рзНржЪрж┐ржд рж╣рж▓рзЗ, ржЖржкржирж╛рж░ ржЙрждрзНрждрж░рзЗрж░ рж╢рзБрж░рзБрждрзЗ ржЕржмрж╢рзНржпржЗ "[ORDER_CONFIRMED]" ржЯрзНржпрж╛ржЧржЯрж┐ ржпрзЛржЧ ржХрж░ржмрзЗржиред ржПрж░ржкрж░ ржПржХржЯрж┐ ржирждрзБржи рж▓рж╛ржЗржирзЗ "[DETAILS:ржирж╛ржо=..., ржарж┐ржХрж╛ржирж╛=..., ржлрзЛржи=...]" ржПржЗ ржлрж░ржорзНржпрж╛ржЯрзЗ ржЧрзНрж░рж╛рж╣ржХрзЗрж░ рж╕ржорзНржкрзВрж░рзНржг рждржерзНржп ржпрзЛржЧ ржХрж░ржмрзЗржиред
    
    ### ржХржерзЛржкржХржержирзЗрж░ ржЙржжрж╛рж╣рж░ржг (Conversation Examples) ###
    ---
    **рж╕рзНржпрж╛ржорзНржкрж▓ рзз: ржкрзНрж░ржержоржмрж╛рж░ ржЕрж░рзНржбрж╛рж░**
    user: "ржПржХржЯрж╛ ржЪрж┐ржХрзЗржи ржирж╛ржЧрзЗржЯ ржЖрж░ ржлрзНрж░рзЗржЮрзНржЪ ржлрзНрж░рж╛ржЗ ржЕрж░рзНржбрж╛рж░ ржХрж░рждрзЗ ржЪрж╛ржЗред"
    (ржмржЯ ржжрзЗржЦржмрзЗ ржХрзЛржирзЛ ржарж┐ржХрж╛ржирж╛ рж╕рзЗржн ржХрж░рж╛ ржирзЗржЗ)
    bot: "ржЕржмрж╢рзНржпржЗ, рж╕рзНржпрж╛рж░/ржорзНржпрж╛ржо! ржЖржкржирж╛рж░ ржЕрж░рзНржбрж╛рж░ржЯрж┐ ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ ржХрж░рж╛рж░ ржЬржирзНржп ржжрзЯрж╛ ржХрж░рзЗ ржЖржкржирж╛рж░ ржкрзБрж░рзЛ ржирж╛ржо, ржбрзЗрж▓рж┐ржнрж╛рж░рж┐ ржарж┐ржХрж╛ржирж╛, ржПржмржВ ржПржХржЯрж┐ рж╕ржЪрж▓ ржлрзЛржи ржиржорзНржмрж░ ржжрж┐ржиред"
    user: "ржирж╛ржо: ржЖржХрж╛рж╢, ржарж┐ржХрж╛ржирж╛: ржорж┐рж░ржкрзБрж░ ржбрж┐ржУржПржЗржЪржПрж╕, рж░рзЛржб-рзз, ржмрж╛рзЬрж┐-рзл, ржврж╛ржХрж╛ред ржлрзЛржи: рзжрззрзмxxxxxxxx"
    bot: "[ORDER_CONFIRMED] [DETAILS:ржирж╛ржо=ржЖржХрж╛рж╢, ржарж┐ржХрж╛ржирж╛=ржорж┐рж░ржкрзБрж░ ржбрж┐ржУржПржЗржЪржПрж╕, рж░рзЛржб-рзз, ржмрж╛рзЬрж┐-рзл, ржврж╛ржХрж╛, ржлрзЛржи=рзжрззрзмxxxxxxxx] ржзржирзНржпржмрж╛ржж, рж╕рзНржпрж╛рж░! ржЖржкржирж╛рж░ ржЕрж░рзНржбрж╛рж░ржЯрж┐ ржХржиржлрж╛рж░рзНржо ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред ЁЯОЙ ржЖржорж░рж╛ ржжрзНрж░рзБржд ржЖржкржирж╛рж░ рж╕рж╛ржерзЗ ржпрзЛржЧрж╛ржпрзЛржЧ ржХрж░ржмред"
    ---
    **рж╕рзНржпрж╛ржорзНржкрж▓ рзи: рж░рж┐ржкрж┐ржЯ ржХрж╛рж╕рзНржЯржорж╛рж░**
    user: "рж╣рж╛ржЗ, ржЖржорж┐ ржХрж┐ржЫрзБ ржлрзНрж░рзЛржЬрзЗржи ржЖржЗржЯрзЗржо ржЕрж░рзНржбрж╛рж░ ржХрж░рждрзЗ ржЪрж╛ржЗред"
    (ржмржЯ ржжрзЗржЦржмрзЗ ржарж┐ржХрж╛ржирж╛ рж╕рзЗржн ржХрж░рж╛ ржЖржЫрзЗ)
    bot: "ржЖржкржирж╛ржХрзЗ ржЖржмрж╛рж░ рж╕рзНржмрж╛ржЧржд, рж╕рзНржпрж╛рж░/ржорзНржпрж╛ржо! ЁЯШК ржЕржмрж╢рзНржпржЗ ржЕрж░рзНржбрж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржиред ржЖржкржирж╛рж░ ржЕрж░рзНржбрж╛рж░ржЯрж┐ ржХрж┐ ржЖржкржирж╛рж░ рж╕рзЗржн ржХрж░рж╛ ржарж┐ржХрж╛ржирж╛ 'ржорж┐рж░ржкрзБрж░ ржбрж┐ржУржПржЗржЪржПрж╕, рж░рзЛржб-рзз, ржмрж╛рзЬрж┐-рзл, ржврж╛ржХрж╛' ржПржЗржЦрж╛ржирзЗ ржкрж╛ржарж┐рзЯрзЗ ржжрзЗржмрзЛ?"
    user: "рж╣рзНржпрж╛ржБ, ржУржЗ ржарж┐ржХрж╛ржирж╛рждрзЗржЗ ржкрж╛ржарж╛ржиред"
    bot: "[ORDER_CONFIRMED] [DETAILS:ржирж╛ржо=ржЖржХрж╛рж╢, ржарж┐ржХрж╛ржирж╛=ржорж┐рж░ржкрзБрж░ ржбрж┐ржУржПржЗржЪржПрж╕, рж░рзЛржб-рзз, ржмрж╛рзЬрж┐-рзл, ржврж╛ржХрж╛, ржлрзЛржи=рзжрззрзмxxxxxxxx] ржзржирзНржпржмрж╛ржж, рж╕рзНржпрж╛рж░! ржЖржкржирж╛рж░ ржЕрж░рзНржбрж╛рж░ржЯрж┐ ржЖржкржирж╛рж░ рж╕рзЗржн ржХрж░рж╛ ржарж┐ржХрж╛ржирж╛рж░ ржЬржирзНржп ржХржиржлрж╛рж░рзНржо ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред ржЖрж░ ржХрж┐ржЫрзБ ржХрж┐ рж▓рж╛ржЧржмрзЗ ржЖржкржирж╛рж░?"
    ---
    """
    
    messages_for_api = [
        {"role": "system", "content": system_prompt}
    ]
    messages_for_api.extend(formatted_history)
    messages_for_api.append({"role": "user", "content": message})

    try:
        chat_completion = groq_client.chat.completions.create(
            messages=messages_for_api,
            model="llama3-70b-8192", # <-- ржкрж░рж┐ржмрж░рзНрждржи: ржирждрзБржи ржПржмржВ рж╢ржХрзНрждрж┐рж╢рж╛рж▓рзА ржоржбрзЗрж▓
        )
        return chat_completion.choices[0].message.content
    except Exception as e:
        print(f"Groq API Error: {e}")
        return "ржжрзБржГржЦрж┐ржд, ржПржХржЯрж┐ ржкрзНрж░ржпрзБржХрзНрждрж┐ржЧржд рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗред ржЖржорж░рж╛ ржмрж┐рж╖рзЯржЯрж┐ ржжрзЗржЦржЫрж┐ред"

def save_customer_details(sender_id, details_str):
    try:
        details = dict(item.split("=") for item in details_str.strip().split(", "))
        if client:
            customer_details_collection.update_one(
                {'sender_id': sender_id},
                {'$set': {
                    'name': details.get('ржирж╛ржо'),
                    'address': details.get('ржарж┐ржХрж╛ржирж╛'),
                    'phone': details.get('ржлрзЛржи'),
                    'last_updated': datetime.utcnow()
                }},
                upsert=True
            )
            print(f"ржЧрзНрж░рж╛рж╣ржХ {sender_id}-ржПрж░ рждржерзНржп рж╕рзЗржн/ржЖржкржбрзЗржЯ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред")
    except Exception as e:
        print(f"ржЧрзНрж░рж╛рж╣ржХрзЗрж░ рждржерзНржп ржкрж╛рж░рзНрж╕ ржмрж╛ рж╕рзЗржн ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛: {e}")

def get_saved_customer_details(sender_id):
    if client:
        details = customer_details_collection.find_one({'sender_id': sender_id})
        if details:
             return details
    return None

def save_message_to_db(sender_id, role, content):
    if client:
        chat_history_collection.insert_one({
            'sender_id': sender_id,
            'role': role,
            'content': content,
            'timestamp': datetime.utcnow()
        })

def get_chat_history(sender_id, limit=5):
    if client:
        history_cursor = chat_history_collection.find({'sender_id': sender_id}).sort('timestamp', -1).limit(limit)
        return list(history_cursor)[::-1]
    return []

def send_otn_request(recipient_id):
    params = {'access_token': FACEBOOK_PAGE_ACCESS_TOKEN}
    headers = {'Content-Type': 'application/json'}
    data = {
        'recipient': {'id': recipient_id},
        'message': {
            "attachment": {
                "type": "template",
                "payload": {
                    "template_type": "one_time_notif_req",
                    "title": "ржЖржорж╛ржжрзЗрж░ ржкрж░ржмрж░рзНрждрзА ржЕржлрж╛рж░ рж╕ржорзНржкрж░рзНржХрзЗ ржЬрж╛ржирждрзЗ ржЪрж╛ржи?",
                    "payload": "notify_me_payload" 
                }
            }
        }
    }
    requests.post(GRAPH_API_URL, params=params, headers=headers, json=data)

def send_telegram_notification(order_details):
    if not TELEGRAM_USERNAME or not CALLMEBOT_API_KEY:
        print("Telegram ржирзЛржЯрж┐ржлрж┐ржХрзЗрж╢ржирзЗрж░ ржЬржирзНржп ржкрзНрж░рзЯрзЛржЬржирзАрзЯ рждржерзНржп рж╕рзЗржЯ ржХрж░рж╛ ржирзЗржЗред")
        return
    message_body = f"*ржирждрзБржи ржЕрж░рзНржбрж╛рж░ ржПрж╕рзЗржЫрзЗ!*\n\n{order_details.replace('[ORDER_CONFIRMED]', '').strip()}"
    encoded_message = urllib.parse.quote_plus(message_body)
    api_url = f"https://api.callmebot.com/text.php?user={TELEGRAM_USERNAME}&text={encoded_message}&apikey={CALLMEBOT_API_KEY}"
    try:
        response = requests.get(api_url, timeout=10)
        if response.status_code == 200:
            print("рж╕ржлрж▓ржнрж╛ржмрзЗ Telegram ржирзЛржЯрж┐ржлрж┐ржХрзЗрж╢ржи ржкрж╛ржарж╛ржирзЛ рж╣рзЯрзЗржЫрзЗред")
        else:
            print(f"Telegram ржирзЛржЯрж┐ржлрж┐ржХрзЗрж╢ржи ржкрж╛ржарж╛рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗ: {response.text}")
    except requests.exceptions.RequestException as e:
        print(f"CallMeBot API-рждрзЗ ржХрж▓ ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗ: {e}")

def get_or_create_label_id(label_name):
    get_labels_url = f"https://graph.facebook.com/v18.0/me/custom_labels"
    params = {'fields': 'name', 'access_token': FACEBOOK_PAGE_ACCESS_TOKEN}
    try:
        response = requests.get(get_labels_url, params=params, timeout=10)
        response.raise_for_status()
        existing_labels = response.json().get('data', [])
        for label in existing_labels:
            if label.get('name') == label_name:
                return label.get('id')
        create_label_url = f"https://graph.facebook.com/v18.0/me/custom_labels"
        data = {'name': label_name}
        response = requests.post(create_label_url, params={'access_token': FACEBOOK_PAGE_ACCESS_TOKEN}, json=data, timeout=10)
        response.raise_for_status()
        new_label = response.json()
        return new_label.get('id')
    except requests.exceptions.RequestException as e:
        print(f"рж▓рзЗржмрзЗрж▓ рждрзИрж░рж┐ ржмрж╛ ржЦрзБржБржЬрждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗ: {e}")
        return None

def apply_date_label(user_psid):
    today_label_name = datetime.now().strftime("%d-%m-%Y")
    label_id = get_or_create_label_id(today_label_name)
    if not label_id:
        return
    apply_label_url = f"https://graph.facebook.com/v18.0/{label_id}/label"
    params = {'user': user_psid, 'access_token': FACEBOOK_PAGE_ACCESS_TOKEN}
    try:
        response = requests.post(apply_label_url, params=params, timeout=10)
        response.raise_for_status()
        if response.json().get('success'):
            print(f"ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзА {user_psid}-ржХрзЗ рж╕ржлрж▓ржнрж╛ржмрзЗ '{today_label_name}' рж▓рзЗржмрзЗрж▓ ржжрзЗржУрзЯрж╛ рж╣рзЯрзЗржЫрзЗред")
    except requests.exceptions.RequestException as e:
        print(f"ржлрзЗрж╕ржмрзБржХ рж▓рзЗржмрзЗрж▓ API-рждрзЗ ржХрж▓ ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗ: {e}")

def send_facebook_message(recipient_id, message_text):
    params = {'access_token': FACEBOOK_PAGE_ACCESS_TOKEN}
    headers = {'Content-Type': 'application/json'}
    data = {
        'recipient': {'id': recipient_id},
        'message': {'text': message_text},
        'messaging_type': 'RESPONSE'
    }
    try:
        requests.post(GRAPH_API_URL, params=params, headers=headers, json=data, timeout=10)
    except requests.exceptions.RequestException as e:
        print(f"ржлрзЗрж╕ржмрзБржХрзЗ ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗ: {e}")

